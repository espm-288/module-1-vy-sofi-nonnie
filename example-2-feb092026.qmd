---
title: "Module 1: Tabular Data"
subtitle: "Working with larger-than-RAM data using duckdbfs"
author: "ESPM 288"
format: 
  html:
    embed-resources: true
    code-fold: true
---

## Introduction

In this module, we will explore high-performance workflows for tabular data. We will use `duckdbfs` to work with datasets that are larger than available RAM by leveraging DuckDB's streaming and remote file access capabilities.

## Case Study: Global Supply Chains

We will be working with [EXIOBASE 3.8.1](https://source.coop/youssef-harby/exiobase-3), a global Multi-Regional Input-Output (MRIO) database. This dataset tracks economic transactions between sectors and regions, along with their environmental impacts (emissions, resource use, etc.).

**Data description:**
- **Coverage**: 44 countries + 5 rest-of-world regions.
- **Timeframe**: 1995â€“2022.
- **Content**: Economic transactions (Z matrix), final demand (Y matrix), and environmental stressors (F matrix).
- **Format**: Cloud-optimized Parquet, partitioned by year and matrix type.

## Setup

```{r}
library(duckdbfs)
library(dplyr)
library(ggplot2)

```

## Exercise 1: connecting to remote data

We can open the entire dataset without downloading it using `open_dataset()`. The data is hosted on Source Cooperative. The `**` pattern allows recursive scanning of the partitioned parquet files.

```{r}
# Remote S3 path to EXIOBASE 3 (Source Cooperative)

duckdbfs::duckdb_secrets(
    key = "",
    secret = "",
    endpoint = "s3.amazonaws.com",
    region = "us-west-2"
)
s3_url <- "s3://us-west-2.opendata.source.coop/youssef-harby/exiobase-3/4588235/parquet/**"

# Open the dataset lazily
exio <- open_dataset(s3_url)

# View the schema (column names and types) without reading data
glimpse(exio)
```

## Example 2 - In Class Exercise - Feb 9, 2026

```{r}
co2 <- exio |> 
    filter(matrix == "F_satellite") |>
    filter(grepl("CO2|carbon dioxide", stressor, ignore.case = TRUE))

co2
```

Identify which regions are the tops 5 CO2 emitters.
```{r}
co2 |>
    group_by(region) |>
    summarize(total_co2 = sum(value, na.rm = TRUE)) |>
    arrange(desc(total_co2)) |>
    head(5) |>
    collect()
```

Identify which sectors are the top co2 producers.
```{r}
top_sector_polluters <-co2 |>
    group_by(sector) |>
    summarize(total_co2 = sum(value, na.rm = TRUE)) |>
    arrange(desc(total_co2)) |>
    head(5) |>
    collect()

top_sector_polluters
```

```{r}
by_sector <- co2 |>
    group_by(sector, year) |>
    summarize(total_co2 = sum(value, na.rm = TRUE))

by_sector

```


Create a time series by sector for total co2 emissions worldwide from 1995-2022.
```{r}
p <- ggplot(by_sector, aes(x = year, y = total_co2, color = sector, group = sector)) +
    geom_line(linewidth = 1.2) +
    geom_point(size = 2) +
    scale_color_brewer(palette = "Set3") +
    labs(title = "CO2 Emissions by Sector (1995-2022)",
         subtitle = "Top 10 emitting sectors",
         x = "Year",
         y = "Total CO2 Emissions",
         color = "Sector") +
    theme_minimal() +
    theme(plot.title = element_text(size = 16, face = "bold"),
          plot.subtitle = element_text(size = 12),
          legend.position = "right")

ggsave("co2_trends.png", p, width = 14, height = 4, dpi = 300)
p
````


